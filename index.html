<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRMNL Secure Viewer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f4; }
        #display-area { margin: 20px auto; border: 2px solid #333; max-width: 600px; min-height: 300px; background: white; }
        img { width: 100%; height: auto; }
        .controls { display: flex; flex-direction: column; gap: 10px; max-width: 300px; margin: 0 auto; }
        input { padding: 8px; }
        button { padding: 10px; cursor: pointer; background: #000; color: #fff; border: none; border-radius: 4px; }
        .hidden { display: none; }
        #settings-toggle { margin-top: 20px; font-size: 0.8em; color: #666; cursor: pointer; }
    </style>
</head>
<body>

    <h1>TRMNL Viewer</h1>
    
    <div id="setup-section" class="hidden">
        <h3>Secure Setup</h3>
        <div class="controls">
            <input type="text" id="token-input" placeholder="TRMNL Access Token">
            <input type="password" id="pin-input" placeholder="Encryption PIN">
            <button id="save-btn">Encrypt & Save Token</button>
        </div>
    </div>

    <div id="main-section">
        <div class="controls">
            <input type="password" id="unlock-pin" placeholder="Enter PIN to Fetch">
            <button id="fetch-btn">Download Image</button>
        </div>
        <div id="display-area"><p id="status">Enter PIN and press Download</p></div>
    </div>

    <p id="settings-toggle">Reset/Update Token</p>

    <script src="crypto-logic.js"></script>
    <script>
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        const PROXY_URL = 'https://corsproxy.io/?';
        const TRMNL_API = 'https://usetrmnl.com/api/display/'; // Note: Append ID if needed

        // UI Logic
        const setupSection = document.getElementById('setup-section');
        const mainSection = document.getElementById('main-section');
        const status = document.getElementById('status');

        // Check if token exists in local storage
        if (!localStorage.getItem('encryptedToken')) {
            setupSection.classList.remove('hidden');
            mainSection.classList.add('hidden');
        }

        document.getElementById('save-btn').onclick = async () => {
            const token = document.getElementById('token-input').value;
            const pin = document.getElementById('pin-input').value;
            if(!token || !pin) return alert("Fill both fields");
            
            const encrypted = await encryptData(token, pin);
            localStorage.setItem('encryptedToken', JSON.stringify(encrypted));
            location.reload();
        };

        document.getElementById('fetch-btn').onclick = async () => {
            const pin = document.getElementById('unlock-pin').value;
            const encryptedData = JSON.parse(localStorage.getItem('encryptedToken'));
            
            try {
                status.innerText = "Decrypting...";
                const token = await decryptData(encryptedData, pin);
                
                status.innerText = "Fetching via Proxy...";
                // Update URL construction based on your TRMNL endpoint requirements
                const finalUrl = `${TRMNL_API}${token}`; 
                
                const response = await fetch(PROXY_URL + encodeURIComponent(finalUrl));
                if (!response.ok) throw new Error('Fetch failed');
                
                const blob = await response.blob();
                const objectURL = URL.createObjectURL(blob);
                document.getElementById('display-area').innerHTML = `<img src="${objectURL}">`;
            } catch (e) {
                status.innerText = "Error: Invalid PIN or Network Issue";
            }
        };

        document.getElementById('settings-toggle').onclick = () => {
            localStorage.removeItem('encryptedToken');
            location.reload();
        };
    </script>
</body>
</html>
